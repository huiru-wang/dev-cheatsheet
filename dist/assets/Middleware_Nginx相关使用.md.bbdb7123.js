import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.fd95ed2e.js";const h=JSON.parse('{"title":"Nginx","description":"","frontmatter":{},"headers":[],"relativePath":"Middleware/Nginx相关使用.md","filePath":"Middleware/Nginx相关使用.md"}'),p={name:"Middleware/Nginx相关使用.md"},o=l(`<h1 id="nginx" tabindex="-1">Nginx <a class="header-anchor" href="#nginx" aria-label="Permalink to &quot;Nginx&quot;">​</a></h1><h2 id="常用命令" tabindex="-1">常用命令 <a class="header-anchor" href="#常用命令" aria-label="Permalink to &quot;常用命令&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">./nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#启动</span></span>
<span class="line"><span style="color:#B392F0;">./nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#快速停止</span></span>
<span class="line"><span style="color:#B392F0;">./nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">quit</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#优雅关闭，在退出前完成已经接受的连接请求</span></span>
<span class="line"><span style="color:#B392F0;">./nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reload</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#重新加载配置，不会导致服务中断</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">./nginx</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#启动</span></span>
<span class="line"><span style="color:#6F42C1;">./nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#快速停止</span></span>
<span class="line"><span style="color:#6F42C1;">./nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">quit</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#优雅关闭，在退出前完成已经接受的连接请求</span></span>
<span class="line"><span style="color:#6F42C1;">./nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reload</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#重新加载配置，不会导致服务中断</span></span></code></pre></div><h2 id="配置结构" tabindex="-1">配置结构 <a class="header-anchor" href="#配置结构" aria-label="Permalink to &quot;配置结构&quot;">​</a></h2><ul><li>全局配置</li><li>event：工作模式、连接数</li><li>http：http全局配置 <ul><li>upstream：服务负载均衡配置</li><li>server：每个server为一个代理服务 <ul><li>location：路由相关配置</li></ul></li></ul></li></ul><h2 id="常用配置" tabindex="-1">常用配置 <a class="header-anchor" href="#常用配置" aria-label="Permalink to &quot;常用配置&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">worker_processes</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># 进程数，对应物理CPU核心数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">events</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">epoll</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">worker_connections</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># 每一个woker进程 创建的连接数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#B392F0;">http</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">include</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">mime.types</span><span style="color:#E1E4E8;">;   </span><span style="color:#6A737D;"># 定义用户可访问的文件类型及对应的请求头</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 如果请求的文件不在mime.types中就默认使用octet-stream，二进制流</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">default_type</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">application/octet-stream</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#access_log  logs/access.log  main;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">sendfile</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># 零拷贝</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#tcp_nopush     on; # 提升传输效率，必须开启sendfile</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">keepalive_timeout</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">65</span><span style="color:#E1E4E8;">;  </span><span style="color:#6A737D;"># 长连接 超时时间</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#gzip  on;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.96.1:9999</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">weight=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.96.1:9998</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">weight=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.96.2:9997</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">weight=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.104.1:9999</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">weight=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.105.1:9998</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">weight=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.106.2:9997</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">weight=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">listen</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server_name</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">haiah.life</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/api</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># 设置转发的header</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-Real-IP</span><span style="color:#E1E4E8;"> $remote_addr;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-Forwarded-For</span><span style="color:#E1E4E8;"> $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Host</span><span style="color:#E1E4E8;"> $http_host;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-NginX-Proxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_pass</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://cluster</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">error_page</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">502</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">503</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/50x.html</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># 如果5xx，则返回 http://localhost/50x.html</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/50x.html{</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># 如果没有/50x.html 返回</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">html</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">listen</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server_name</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">cun.com</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-Real-IP</span><span style="color:#E1E4E8;"> $remote_addr;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-Forwarded-For</span><span style="color:#E1E4E8;"> $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Host</span><span style="color:#E1E4E8;"> $http_host;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-NginX-Proxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">proxy_pass</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://cluster2</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">worker_processes</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># 进程数，对应物理CPU核心数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">events</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">use</span><span style="color:#24292E;"> </span><span style="color:#032F62;">epoll</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">worker_connections</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># 每一个woker进程 创建的连接数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6F42C1;">http</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">include</span><span style="color:#24292E;">       </span><span style="color:#032F62;">mime.types</span><span style="color:#24292E;">;   </span><span style="color:#6A737D;"># 定义用户可访问的文件类型及对应的请求头</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 如果请求的文件不在mime.types中就默认使用octet-stream，二进制流</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">default_type</span><span style="color:#24292E;">  </span><span style="color:#032F62;">application/octet-stream</span><span style="color:#24292E;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#access_log  logs/access.log  main;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">sendfile</span><span style="color:#24292E;">        </span><span style="color:#032F62;">on</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># 零拷贝</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#tcp_nopush     on; # 提升传输效率，必须开启sendfile</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">keepalive_timeout</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">65</span><span style="color:#24292E;">;  </span><span style="color:#6A737D;"># 长连接 超时时间</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">#gzip  on;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">upstream</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.96.1:9999</span><span style="color:#24292E;"> </span><span style="color:#032F62;">weight=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.96.1:9998</span><span style="color:#24292E;"> </span><span style="color:#032F62;">weight=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.96.2:9997</span><span style="color:#24292E;"> </span><span style="color:#032F62;">weight=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">upstream</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.104.1:9999</span><span style="color:#24292E;"> </span><span style="color:#032F62;">weight=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.105.1:9998</span><span style="color:#24292E;"> </span><span style="color:#032F62;">weight=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.106.2:9997</span><span style="color:#24292E;"> </span><span style="color:#032F62;">weight=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">listen</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server_name</span><span style="color:#24292E;">  </span><span style="color:#032F62;">haiah.life</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">location</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/api</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># 设置转发的header</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-Real-IP</span><span style="color:#24292E;"> $remote_addr;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-Forwarded-For</span><span style="color:#24292E;"> $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Host</span><span style="color:#24292E;"> $http_host;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-NginX-Proxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_pass</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://cluster</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">error_page</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">500</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">502</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">503</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/50x.html</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># 如果5xx，则返回 http://localhost/50x.html</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">location</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/50x.html{</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># 如果没有/50x.html 返回</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">html</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">listen</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server_name</span><span style="color:#24292E;">  </span><span style="color:#032F62;">cun.com</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">location</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-Real-IP</span><span style="color:#24292E;"> $remote_addr;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-Forwarded-For</span><span style="color:#24292E;"> $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Host</span><span style="color:#24292E;"> $http_host;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-NginX-Proxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">proxy_pass</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://cluster2</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="upstream负载均衡" tabindex="-1">upstream负载均衡 <a class="header-anchor" href="#upstream负载均衡" aria-label="Permalink to &quot;upstream负载均衡&quot;">​</a></h2><p>声明一个server集群，实现负载均衡；ip:port唯一确定一个节点；</p><ul><li>down：下线；backup：备用，只有其他节点全不可用才会使用；这两个参数都不咋常用；</li></ul><p>负载均衡策略： 1、轮询 仅用于无状态的服务；请求会不断在后端节点间轮询；</p><p>2、权重</p><p>3、ip_hash 根据ip对后台节点数量进行hash，容易流量倾斜；</p><p>4、least_conn 最少连接访问</p><p>5、url_hash 根据用户访问的url定向转发请求，用于状态类的服务，特定服务总会落到特定集群；</p><p>一般用于服务器拥有特定资源，定向转发</p><p>(需要第三方插件)</p><h2 id="server虚拟主机" tabindex="-1">server虚拟主机 <a class="header-anchor" href="#server虚拟主机" aria-label="Permalink to &quot;server虚拟主机&quot;">​</a></h2><p>配置多个server，代理多个虚拟主机</p><ul><li>host:port确定唯一server，且按顺序匹配请求；</li><li>server_name支持正则、通配符：<code>~^[0-9]+\\.haiah\\.com$</code>、<code>*.haiah.com</code></li><li>server_name使用单节点而非upstream时，需要http://</li><li>server_name不支持https协议</li></ul><h2 id="location" tabindex="-1">location <a class="header-anchor" href="#location" aria-label="Permalink to &quot;location&quot;">​</a></h2><p>匹配到指定路径，进行转发</p><p>匹配模式：</p><ul><li>/api/xxx：通用的以path从前向后匹配；</li><li>=/api/pro/list：精准匹配；</li><li>~：正则匹配，区分大小写；</li><li>~*：正则匹配，不区分大小写；</li><li>^~：非正则匹配，</li></ul><p>匹配顺序： 1、多个<strong>正则location</strong>同时满足，则按顺序，先匹配则不会向后再匹配； 2、多个<strong>非正则location</strong>同时满足，则全部匹配，最后选取匹配度最高的location转发；</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">location /example {</span></span>
<span class="line"><span style="color:#e1e4e8;">  proxy_pass http://127.0.0.1:8080;</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">location /example {</span></span>
<span class="line"><span style="color:#24292e;">  proxy_pass http://127.0.0.1:8080;</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><h2 id="引入子配置文件" tabindex="-1">引入子配置文件 <a class="header-anchor" href="#引入子配置文件" aria-label="Permalink to &quot;引入子配置文件&quot;">​</a></h2><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- nginx.conf</span></span>
<span class="line"><span style="color:#e1e4e8;">   | -- default.conf</span></span>
<span class="line"><span style="color:#e1e4e8;">   | -- server1.conf</span></span>
<span class="line"><span style="color:#e1e4e8;">   | -- server2.conf</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 全局配置中加入相对路径引入</span></span>
<span class="line"><span style="color:#e1e4e8;">include server1.conf;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- nginx.conf</span></span>
<span class="line"><span style="color:#24292e;">   | -- default.conf</span></span>
<span class="line"><span style="color:#24292e;">   | -- server1.conf</span></span>
<span class="line"><span style="color:#24292e;">   | -- server2.conf</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 全局配置中加入相对路径引入</span></span>
<span class="line"><span style="color:#24292e;">include server1.conf;</span></span></code></pre></div><p>/opt/blog/docs/.vitepress/dist</p>`,29),e=[o];function t(c,r,E,y,i,F){return n(),a("div",null,e)}const C=s(p,[["render",t]]);export{h as __pageData,C as default};
